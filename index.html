<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #ffffff;
            color: #323130;
            padding: 20px;
            padding-top: 80px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* User Selector in Top Right */
        .user-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f3f2f1;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .current-user:hover {
            background: #edebe9;
        }

        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0078d4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-dropdown-icon {
            font-size: 12px;
            color: #605e5c;
        }

        .user-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-width: 250px;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f2f1;
            transition: background 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f3f2f1;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item.active {
            background: #e6f4ff;
            font-weight: 600;
        }

        /* Auth Modal Overlay */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .auth-overlay.show {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            padding: 32px;
        }

        .auth-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-modal-subtitle {
            font-size: 14px;
            color: #605e5c;
            margin-bottom: 24px;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .auth-select:focus {
            outline: none;
            border-color: #0078d4;
        }

        .auth-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .auth-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .auth-checkbox-label {
            font-size: 14px;
            color: #323130;
            cursor: pointer;
        }

        .auth-submit-btn {
            width: 100%;
            padding: 12px 24px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-submit-btn:hover {
            background: #106ebe;
        }

        .auth-submit-btn:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        /* Header Badges */
        .header-badges {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .badge {
            background: #0078d4;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.streaming {
            background: #8764b8;
        }

        .badge.billing {
            background: #00b7c3;
        }

        /* Main Title */
        .main-title {
            color: #0078d4;
            margin: 0 0 20px 0;
            border-bottom: 1px solid #e1e1e1;
            padding-bottom: 8px;
            font-size: 24px;
            font-weight: 600;
        }

        /* Order Details Grid */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px 24px;
            margin-bottom: 24px;
        }

        .detail-item {
            margin-bottom: 12px;
        }

        .detail-label {
            color: #605e5c;
            font-size: 12px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Comment Section */
        .comment-section {
            margin-bottom: 24px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .comment-section .detail-label {
            margin-bottom: 8px;
        }

        .comment-section .detail-value {
            font-weight: normal;
        }

        .comment-empty {
            font-style: italic;
            color: #a19f9d;
        }

        /* Status Section */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 24px;
            margin-bottom: 24px;
            border-top: 1px solid #e1e1e1;
            padding-top: 20px;
        }

        .status-item .detail-label {
            font-weight: 700;
        }

        .status-value {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .status-confirmed {
            color: #107c10;
        }

        .status-pending {
            color: #f7630c;
        }

        .status-rejected {
            color: #d13438;
        }

        .status-timestamp {
            font-size: 13px;
            color: #797775;
            font-weight: normal;
        }

        /* Update Button */
        .update-btn {
            margin-top: 24px;
            padding: 12px 32px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .update-btn:hover {
            background: #106ebe;
        }

        /* Files Section */
        .files-section {
            margin-top: 32px;
            border-top: 2px solid #e1e1e1;
            padding-top: 24px;
        }

        .files-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e1e1e1;
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #605e5c;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f3f2f1;
        }

        .tab.active {
            color: #0566b2;
            border-bottom-color: #0566b2;
        }

        /* File List */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #edebe9;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f3f2f1;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 16px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: #605e5c;
            margin-bottom: 8px;
        }

        .file-actions {
            display: flex;
            align-items: center;
            margin-left: 16px;
        }

        .download-btn {
            background: transparent;
            border: 2px solid #0078d4;
            color: #0078d4;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .download-btn:hover {
            background: #0078d4;
            color: white;
        }

        .download-icon {
            font-size: 18px;
        }

        .not-uploaded {
            text-align: center;
            color: #7a8a8f;
            font-size: 16px;
            font-weight: 600;
            padding: 40px;
        }

        /* Update Status Modal */
        .update-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .update-modal-overlay.show {
            display: flex;
        }

        .update-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .update-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #323130;
        }

        .update-form-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .update-form-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #323130;
        }

        .update-form-group {
            margin-bottom: 16px;
        }

        .update-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .update-form-label .required {
            color: #d13438;
        }

        .update-form-select,
        .update-form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
        }

        .update-form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .update-form-select:focus,
        .update-form-textarea:focus {
            outline: none;
            border-color: #0078d4;
        }

        .update-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .update-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .update-modal-btn.cancel {
            background: #f3f2f1;
            color: #323130;
        }

        .update-modal-btn.cancel:hover {
            background: #e1e1e1;
        }

        .update-modal-btn.submit {
            background: #0078d4;
            color: white;
        }

        .update-modal-btn.submit:hover {
            background: #106ebe;
        }

        .update-modal-btn.submit:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        /* Debug Box - Bottom Right */
        .debug-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #323130;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            max-width: 300px;
        }

        .debug-box-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #00ff00;
        }

        .debug-box-content {
            line-height: 1.5;
        }

        .debug-box-content div {
            margin-bottom: 4px;
        }

        .debug-box-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            line-height: 20px;
        }

        .debug-box-close:hover {
            color: #ff0000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- User Authentication Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2 class="auth-modal-title">Select Your Account</h2>
            <p class="auth-modal-subtitle">Choose your account to continue</p>
            
            <div class="auth-form-group">
                <label class="auth-form-label" for="userSelect">Your Account</label>
                <select class="auth-select" id="userSelect">
                    <option value="">-- Select Your Account --</option>
                </select>
            </div>

            <div class="auth-checkbox-group">
                <input type="checkbox" id="rememberMe" class="auth-checkbox">
                <label for="rememberMe" class="auth-checkbox-label">Remember me on this device</label>
            </div>

            <button class="auth-submit-btn" id="authSubmit" disabled>Continue</button>
        </div>
    </div>

    <!-- User Selector in Top Right -->
    <div class="user-selector" id="userSelector" style="display: none;">
        <div class="current-user" onclick="toggleUserDropdown()">
            <div class="user-icon" id="userIcon"></div>
            <span class="user-name" id="currentUserName"></span>
            <span class="user-dropdown-icon">‚ñº</span>
        </div>
        <div class="user-dropdown-menu" id="userDropdownMenu"></div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- Content will be loaded here -->
    </div>

    <!-- Main Content Template (Hidden) -->
    <template id="mainContentTemplate">
        <div style="position: relative;">
            <div class="header-badges">
                <div class="badge">New Order</div>
                <div class="badge streaming" id="streamingBadge"></div>
                <div class="badge billing" id="billingBadge"></div>
            </div>

            <h2 class="main-title">Order Details - OPID <span id="opid"></span></h2>

            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Advertiser</div>
                    <div class="detail-value" id="advertiser"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Agency</div>
                    <div class="detail-value" id="agency"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Vendor</div>
                    <div class="detail-value" id="vendor"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Flight Dates</div>
                    <div class="detail-value" id="flightDates"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">AE</div>
                    <div class="detail-value" id="ae"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">CM</div>
                    <div class="detail-value" id="cm"></div>
                </div>
            </div>

            <div class="comment-section">
                <div class="detail-label">AMP Comment</div>
                <div class="detail-value" id="ampComment"></div>
            </div>

            <div class="status-grid">
                <div class="status-item">
                    <div class="detail-label">Order Status</div>
                    <div class="status-value" id="orderStatus"></div>
                    <div class="status-timestamp" id="orderStatusTime"></div>
                </div>
                <div class="status-item">
                    <div class="detail-label">Traffic Status</div>
                    <div class="status-value" id="trafficStatus"></div>
                    <div class="status-timestamp" id="trafficStatusTime"></div>
                </div>
            </div>

            <button class="update-btn" onclick="openUpdateForm()">Submit an update</button>
            <button class="update-btn" onclick="emailTeam()" style="margin-left: 12px; background: #f3f2f1; color: #323130; border: 2px solid #0078d4;">üìß Email the Team</button>
        </div>

        <!-- Files Section -->
        <div class="files-section">
            <div class="files-header">
                <div class="tabs">
                    <button class="tab active" data-type="IO" onclick="switchTab('IO')">IO</button>
                    <button class="tab" data-type="Traffic" onclick="switchTab('Traffic')">Traffic</button>
                    <button class="tab" data-type="Other" onclick="switchTab('Other')">Other</button>
                </div>
            </div>

            <div class="file-list" id="fileList"></div>
        </div>
    </template>

    <!-- Update Status Modal -->
    <div class="update-modal-overlay" id="updateModalOverlay">
        <div class="update-modal">
            <h2 class="update-modal-title">Update Order Status</h2>
            
            <div class="update-form-section">
                <h3>Order Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">
                        Status
                    </label>
                    <select class="update-form-select" id="updateOrderStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="orderCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateOrderComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-form-section">
                <h3>Traffic Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">
                        Status
                    </label>
                    <select class="update-form-select" id="updateTrafficStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="trafficCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateTrafficComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-modal-actions">
                <button class="update-modal-btn cancel" onclick="closeUpdateForm()">Cancel</button>
                <button class="update-modal-btn submit" id="submitUpdateBtn" onclick="submitUpdate()">Submit Update</button>
            </div>
        </div>
    </div>

    <!-- Debug Box - Bottom Right -->
    <div class="debug-box" id="debugBox" style="display: none;">
        <button class="debug-box-close" onclick="closeDebugBox()">√ó</button>
        <div class="debug-box-title">Debug Info</div>
        <div class="debug-box-content" id="debugContent"></div>
    </div>

    <script>
        // User data
        const usersData = [
            {
                "name": "Kostia Rymar",
                "email": "kostiantyn.rymar@ampersand.tv",
                "initials": "KR"
            },
            {
                "name": "Kostia Rymar (Guest)",
                "email": "rymarkostia@gmail.com",
                "initials": "KR"
            },
            {
                "name": "Salsa Chebli",
                "email": "salsabil.c@gmail.com",
                "initials": "SC"
            },
            {
                "name": "Natasha Levinsohn",
                "email": "Natasha.Levinsohn@ampersand.tv",
                "initials": "NL"
            },
            {
                "name": "Maura Riley",
                "email": "Maura.Riley@ampersand.tv",
                "initials": "MR"
            }
        ];

        let orderData = null;
        let filesData = null;

        let currentTab = 'IO';
        let currentUser = null;
        let orderId = null;

        const API_BASE_URL = 'https://default4657d5eea660475fbb1099b5df3efd.46.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c64389bbba15477eb0b909200beb65b1/triggers/manual/paths/invoke';

        // Fetch order data from Power Automate
        async function fetchOrderData(id) {
            try {
                // Construct URL exactly as it works in your test
                const url = API_BASE_URL + '?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OymdpruJbg2QyqJstyrh8qKTXDltEiQax89t2odSIvc&id=' + id;
                
                console.log('Fetching from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    showErrorModal();
                    return false;
                }

                const data = await response.json();
                console.log('Response data:', data);

                // Validate response structure
                if (!data.order || !data.files) {
                    console.error('Invalid response structure:', data);
                    showErrorModal();
                    return false;
                }

                orderData = data.order;
                filesData = data.files;
                return true;

            } catch (error) {
                console.error('Error fetching order data:', error);
                showErrorModal();
                return false;
            }
        }

        // Show error modal
        function showErrorModal() {
            const errorHtml = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;">' +
                '<div style="background: white; padding: 40px; border-radius: 8px; max-width: 500px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">' +
                    '<div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>' +
                    '<h2 style="color: #d13438; margin-bottom: 16px; font-size: 24px;">Unable to Load Order</h2>' +
                    '<p style="color: #605e5c; margin-bottom: 24px; font-size: 16px; line-height: 1.5;">We couldn\'t retrieve the order information. This could be due to an invalid order ID or a connection issue.</p>' +
                    '<p style="color: #323130; font-weight: 600; margin-bottom: 24px; font-size: 14px;">Please reach out to the team via email for assistance.</p>' +
                    '<a href="mailto:support@ampersand.tv?subject=Order Access Issue&body=I am unable to access order details. Please assist." style="display: inline-block; padding: 12px 32px; background: #0078d4; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 16px;">Email Support Team</a>' +
                '</div>' +
            '</div>';

            document.body.insertAdjacentHTML('beforeend', errorHtml);
        }

        // Extract order ID from URL path
        function extractOrderIdFromPath() {
            // First check query parameter (works reliably)
            const urlParams = new URLSearchParams(window.location.search);
            const queryId = urlParams.get('id');
            if (queryId) {
                return queryId;
            }
            
            // Then try path extraction
            const path = window.location.pathname;
            // Remove file names like index.html or order_detail_complete.html
            const cleanPath = path.replace('/ampdigital/', '').replace('/ampdigital', '').replace('.html', '');
            const parts = cleanPath.split('/').filter(function(p) { return p && p.trim() !== ''; });
            
            // Look for numeric ID in path parts
            for (let i = parts.length - 1; i >= 0; i--) {
                const part = parts[i];
                if (!isNaN(part) && part !== '') {
                    return part;
                }
            }
            
            return null;
        }

        // Show debug box
        function showDebugBox() {
            const debugBox = document.getElementById('debugBox');
            const debugContent = document.getElementById('debugContent');
            
            const fullUrl = window.location.href;
            const path = window.location.pathname;
            const search = window.location.search;
            const extractedId = extractOrderIdFromPath();
            
            debugContent.innerHTML = '<div><strong>Full URL:</strong> ' + fullUrl + '</div>' +
                '<div><strong>Path:</strong> ' + path + '</div>' +
                '<div><strong>Query:</strong> ' + (search || 'none') + '</div>' +
                '<div><strong>Extracted ID:</strong> ' + (extractedId || 'not found') + '</div>' +
                '<div><strong>User:</strong> ' + (currentUser ? currentUser.email : 'not logged in') + '</div>';
            
            debugBox.style.display = 'block';
            
            setTimeout(function() {
                debugBox.style.display = 'none';
            }, 10000);
        }

        function closeDebugBox() {
            document.getElementById('debugBox').style.display = 'none';
        }

        // Check authentication
        function checkAuthentication() {
            orderId = extractOrderIdFromPath();
            
            // Show debug box if ID is found
            if (orderId) {
                showDebugBox();
            } else {
                // No order ID provided
                showErrorModal();
                return;
            }
            
            const savedUser = localStorage.getItem('selectedUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainContent();
                } catch (e) {
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
        }

        // Show auth modal
        function showAuthModal() {
            const authOverlay = document.getElementById('authOverlay');
            const userSelect = document.getElementById('userSelect');
            
            usersData.forEach(function(user) {
                const option = document.createElement('option');
                option.value = JSON.stringify(user);
                option.textContent = user.name + ' (' + user.email + ')';
                userSelect.appendChild(option);
            });
            
            authOverlay.classList.add('show');
        }

        // Auth submit handler
        document.getElementById('userSelect').addEventListener('change', function() {
            const submitBtn = document.getElementById('authSubmit');
            submitBtn.disabled = !this.value;
        });

        document.getElementById('authSubmit').addEventListener('click', function() {
            const userSelect = document.getElementById('userSelect');
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (userSelect.value) {
                currentUser = JSON.parse(userSelect.value);
                
                if (rememberMe) {
                    localStorage.setItem('selectedUser', JSON.stringify(currentUser));
                }
                
                document.getElementById('authOverlay').classList.remove('show');
                showMainContent();
            }
        });

        // Show main content
        async function showMainContent() {
            document.getElementById('userIcon').textContent = currentUser.initials;
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('userSelector').style.display = 'block';
            
            populateUserDropdown();
            
            // Show loading state
            const mainContent = document.getElementById('mainContent');
            mainContent.style.display = 'block';
            mainContent.innerHTML = '<div style="text-align: center; padding: 100px 20px;">' +
                '<div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>' +
                '<div style="font-size: 20px; color: #605e5c;">Loading order details...</div>' +
            '</div>';
            
            // Fetch order data
            const success = await fetchOrderData(orderId);
            
            if (success) {
                // Clone and insert template content
                const template = document.getElementById('mainContentTemplate');
                mainContent.innerHTML = template.innerHTML;
                initializePage();
            }
        }

        // Populate user dropdown
        function populateUserDropdown() {
            const dropdownMenu = document.getElementById('userDropdownMenu');
            dropdownMenu.innerHTML = '';
            
            usersData.forEach(function(user) {
                const item = document.createElement('div');
                item.className = 'user-dropdown-item';
                if (user.email === currentUser.email) {
                    item.classList.add('active');
                }
                item.innerHTML = '<div style="font-weight: 600;">' + user.name + '</div>' +
                    '<div style="font-size: 12px; color: #605e5c;">' + user.email + '</div>';
                item.onclick = function() {
                    switchUser(user);
                };
                dropdownMenu.appendChild(item);
            });
        }

        // Toggle dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown on outside click
        document.addEventListener('click', function(event) {
            const userSelector = document.getElementById('userSelector');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (!userSelector.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Switch user
        function switchUser(user) {
            currentUser = user;
            localStorage.setItem('selectedUser', JSON.stringify(currentUser));
            
            document.getElementById('userIcon').textContent = user.initials;
            document.getElementById('currentUserName').textContent = user.name;
            
            populateUserDropdown();
            document.getElementById('userDropdownMenu').classList.remove('show');
            
            console.log('User switched to:', user.email);
            logDownloadActivity('User switched', user.email);
        }

        // Initialize page
        function initializePage() {
            populateOrderDetails();
            renderFiles();
        }

        function populateOrderDetails() {
            document.getElementById('streamingBadge').textContent = orderData.StreamingvsAddressable ? orderData.StreamingvsAddressable.Value : 'N/A';
            document.getElementById('billingBadge').textContent = orderData.Billingparty ? orderData.Billingparty.Value : 'N/A';
            document.getElementById('opid').textContent = orderData.OPID || 'N/A';
            document.getElementById('advertiser').textContent = orderData.Title || 'N/A';
            document.getElementById('agency').textContent = orderData.Agency || 'N/A';
            document.getElementById('vendor').textContent = orderData.MVPDContacts ? orderData.MVPDContacts.Value : 'N/A';
            
            const flightStart = formatDate(orderData.FlightStart);
            const flightEnd = formatDate(orderData.FlightEnd);
            document.getElementById('flightDates').textContent = flightStart + ' - ' + flightEnd;
            
            document.getElementById('ae').textContent = orderData.AE ? orderData.AE.DisplayName : 'N/A';
            document.getElementById('cm').textContent = orderData.CampaignManager ? orderData.CampaignManager.DisplayName : 'N/A';

            const ampCommentEl = document.getElementById('ampComment');
            if (orderData.AMPComment) {
                ampCommentEl.textContent = orderData.AMPComment;
            } else {
                ampCommentEl.innerHTML = '<span class="comment-empty">No comment</span>';
            }

            const orderStatusEl = document.getElementById('orderStatus');
            const orderStatus = orderData.Status ? orderData.Status.Value : 'Unknown';
            orderStatusEl.textContent = orderStatus;
            orderStatusEl.className = 'status-value ' + getStatusClass(orderStatus);
            
            const orderStatusTime = document.getElementById('orderStatusTime');
            if (orderData.Statuschange) {
                let timeText = formatDateTime(orderData.Statuschange);
                if (orderData.StatusUpdatedby) {
                    timeText += ' by ' + orderData.StatusUpdatedby;
                }
                orderStatusTime.textContent = timeText;
            } else {
                orderStatusTime.textContent = 'Never updated';
            }

            const trafficStatusEl = document.getElementById('trafficStatus');
            const trafficStatus = orderData.TrafficStatus ? orderData.TrafficStatus.Value : 'Unknown';
            trafficStatusEl.textContent = trafficStatus;
            trafficStatusEl.className = 'status-value ' + getStatusClass(trafficStatus);
            
            const trafficStatusTime = document.getElementById('trafficStatusTime');
            if (orderData.TrafficStatusChange) {
                let timeText = formatDateTime(orderData.TrafficStatusChange);
                if (orderData.TrafficStatusUpdatedby) {
                    timeText += ' by ' + orderData.TrafficStatusUpdatedby;
                }
                trafficStatusTime.textContent = timeText;
            } else {
                trafficStatusTime.textContent = 'Never updated';
            }
        }

        function getStatusClass(status) {
            if (status === 'Confirmed') return 'status-confirmed';
            if (status === 'Pending') return 'status-pending';
            if (status === 'Rejected') return 'status-rejected';
            return '';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function formatFileDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelector('[data-type="' + tabName + '"]').classList.add('active');
            
            renderFiles();
        }

        function renderFiles() {
            const fileList = document.getElementById('fileList');
            
            const filteredFiles = filesData.filter(function(file) {
                return file.file_type && file.file_type.Value === currentTab;
            });

            if (filteredFiles.length === 0) {
                fileList.innerHTML = '<div class="not-uploaded">No files available for this category</div>';
                return;
            }

            fileList.innerHTML = filteredFiles.map(function(file) {
                const fileName = file['{Name}'] || 'Unnamed File';
                const fileType = file.file_type ? file.file_type.Value : 'Unknown';
                const fileDate = formatFileDate(file.Created);
                
                const fullPath = file['{FullPath}'] || '';
                const downloadUrl = fullPath 
                    ? 'https://datadriventv.sharepoint.com/sites/PoliticalStreaming/_layouts/15/download.aspx?SourceUrl=/sites/PoliticalStreaming/' + encodeURIComponent(fullPath)
                    : '#';

                return '<div class="file-item">' +
                    '<div class="file-info">' +
                        '<div class="file-name">' + fileName + '</div>' +
                        '<div class="file-meta">' + fileDate + ' ‚Ä¢ ' + fileType + '</div>' +
                    '</div>' +
                    '<div class="file-actions">' +
                        '<a href="' + downloadUrl + '" target="_blank" class="download-btn" onclick="logDownload(\'' + fileName + '\')">' +
                            '<span class="download-icon">‚Üì</span>' +
                        '</a>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function logDownload(fileName) {
            logDownloadActivity('File download', currentUser.email, fileName);
        }

        function logDownloadActivity(action, userEmail, fileName) {
            const logData = {
                action: action,
                user: userEmail || (currentUser ? currentUser.email : ''),
                orderId: orderData.ID,
                opid: orderData.OPID,
                file: fileName || null,
                timestamp: new Date().toISOString()
            };
            
            console.log('Activity logged:', logData);
        }

        // Track original values when form opens
        let originalOrderStatus = null;
        let originalTrafficStatus = null;

        // Update Form Functions
        function openUpdateForm() {
            document.getElementById('updateModalOverlay').classList.add('show');
            
            // Store original values
            originalOrderStatus = orderData.Status ? orderData.Status.Value : '';
            originalTrafficStatus = orderData.TrafficStatus ? orderData.TrafficStatus.Value : '';
            
            // Check current statuses
            const currentOrderStatus = orderData.Status ? orderData.Status.Value : '';
            const currentTrafficStatus = orderData.TrafficStatus ? orderData.TrafficStatus.Value : '';
            
            // Get form sections
            const orderSection = document.querySelector('.update-form-section:nth-of-type(1)');
            const trafficSection = document.querySelector('.update-form-section:nth-of-type(2)');
            
            // Disable/enable Order Status section
            if (currentOrderStatus === 'Not Uploaded') {
                orderSection.style.opacity = '0.5';
                orderSection.style.pointerEvents = 'none';
                const orderNote = orderSection.querySelector('.status-disabled-note');
                if (!orderNote) {
                    const note = document.createElement('div');
                    note.className = 'status-disabled-note';
                    note.style.cssText = 'background: #fff4ce; padding: 12px; border-radius: 4px; margin-bottom: 12px; color: #323130; font-size: 14px;';
                    note.innerHTML = '<strong>‚ö†Ô∏è Note:</strong> Order status is "Not Uploaded" and cannot be updated at this time.';
                    orderSection.insertBefore(note, orderSection.firstChild.nextSibling);
                }
                document.getElementById('updateOrderStatus').disabled = true;
                document.getElementById('updateOrderComments').disabled = true;
            } else {
                orderSection.style.opacity = '1';
                orderSection.style.pointerEvents = 'auto';
                const orderNote = orderSection.querySelector('.status-disabled-note');
                if (orderNote) orderNote.remove();
                document.getElementById('updateOrderStatus').disabled = false;
                document.getElementById('updateOrderComments').disabled = false;
            }
            
            // Disable/enable Traffic Status section
            if (currentTrafficStatus === 'Not Uploaded') {
                trafficSection.style.opacity = '0.5';
                trafficSection.style.pointerEvents = 'none';
                const trafficNote = trafficSection.querySelector('.status-disabled-note');
                if (!trafficNote) {
                    const note = document.createElement('div');
                    note.className = 'status-disabled-note';
                    note.style.cssText = 'background: #fff4ce; padding: 12px; border-radius: 4px; margin-bottom: 12px; color: #323130; font-size: 14px;';
                    note.innerHTML = '<strong>‚ö†Ô∏è Note:</strong> Traffic status is "Not Uploaded" and cannot be updated at this time.';
                    trafficSection.insertBefore(note, trafficSection.firstChild.nextSibling);
                }
                document.getElementById('updateTrafficStatus').disabled = true;
                document.getElementById('updateTrafficComments').disabled = true;
            } else {
                trafficSection.style.opacity = '1';
                trafficSection.style.pointerEvents = 'auto';
                const trafficNote = trafficSection.querySelector('.status-disabled-note');
                if (trafficNote) trafficNote.remove();
                document.getElementById('updateTrafficStatus').disabled = false;
                document.getElementById('updateTrafficComments').disabled = false;
            }
            
            updateFormValidation();
        }

        // Email the team
        function emailTeam() {
            const aeEmail = orderData.AE && orderData.AE.DisplayName ? orderData.AE.DisplayName.replace(' ', '.') + '@ampersand.tv' : '';
            const cmEmail = orderData.CampaignManager && orderData.CampaignManager.DisplayName ? orderData.CampaignManager.DisplayName.replace(' ', '.') + '@ampersand.tv' : '';
            
            const toEmails = [aeEmail, cmEmail].filter(function(e) { return e; }).join(',');
            const ccEmail = 'kostiantyn.rymar@ampersand.tv';
            
            const advertiser = orderData.Title || 'Order';
            const flightStart = formatDate(orderData.FlightStart);
            const flightEnd = formatDate(orderData.FlightEnd);
            const opid = orderData.OPID || '';
            
            const subject = advertiser + ' (' + flightStart + ' - ' + flightEnd + ') - ' + opid;
            const body = 'Hi Team,%0D%0A%0D%0AI have a question regarding this order.%0D%0A%0D%0AThank you!';
            
            const mailtoLink = 'mailto:' + toEmails + '?cc=' + ccEmail + '&subject=' + encodeURIComponent(subject) + '&body=' + body;
            
            window.location.href = mailtoLink;
        }

        function closeUpdateForm() {
            document.getElementById('updateModalOverlay').classList.remove('show');
            document.getElementById('updateOrderStatus').value = '';
            document.getElementById('updateOrderComments').value = '';
            document.getElementById('updateTrafficStatus').value = '';
            document.getElementById('updateTrafficComments').value = '';
        }

        function updateFormValidation() {
            const orderStatus = document.getElementById('updateOrderStatus').value;
            const trafficStatus = document.getElementById('updateTrafficStatus').value;
            const orderComments = document.getElementById('updateOrderComments').value.trim();
            const trafficComments = document.getElementById('updateTrafficComments').value.trim();
            
            const orderDisabled = document.getElementById('updateOrderStatus').disabled;
            const trafficDisabled = document.getElementById('updateTrafficStatus').disabled;
            
            const orderCommentLabel = document.getElementById('orderCommentLabel');
            const trafficCommentLabel = document.getElementById('trafficCommentLabel');
            
            if (orderStatus === 'Rejected') {
                orderCommentLabel.innerHTML = 'Comments <span class="required">* (required for rejection)</span>';
            } else {
                orderCommentLabel.innerHTML = 'Comments <span style="color: #605e5c;">(optional)</span>';
            }
            
            if (trafficStatus === 'Rejected') {
                trafficCommentLabel.innerHTML = 'Comments <span class="required">* (required for rejection)</span>';
            } else {
                trafficCommentLabel.innerHTML = 'Comments <span style="color: #605e5c;">(optional)</span>';
            }
            
            let isValid = true;
            
            if (!orderDisabled && orderStatus === 'Rejected' && !orderComments) {
                isValid = false;
            }
            
            if (!trafficDisabled && trafficStatus === 'Rejected' && !trafficComments) {
                isValid = false;
            }
            
            const hasOrderSelection = !orderDisabled && orderStatus;
            const hasTrafficSelection = !trafficDisabled && trafficStatus;
            
            if (!hasOrderSelection && !hasTrafficSelection) {
                isValid = false;
            }
            
            if (orderDisabled && trafficDisabled) {
                isValid = false;
            }
            
            document.getElementById('submitUpdateBtn').disabled = !isValid;
        }

        document.getElementById('updateOrderStatus').addEventListener('change', updateFormValidation);
        document.getElementById('updateTrafficStatus').addEventListener('change', updateFormValidation);
        document.getElementById('updateOrderComments').addEventListener('input', updateFormValidation);
        document.getElementById('updateTrafficComments').addEventListener('input', updateFormValidation);

        function submitUpdate() {
            const orderStatus = document.getElementById('updateOrderStatus').value;
            const trafficStatus = document.getElementById('updateTrafficStatus').value;
            const orderComments = document.getElementById('updateOrderComments').value.trim();
            const trafficComments = document.getElementById('updateTrafficComments').value.trim();
            
            // Determine what changed
            const orderChanged = orderStatus && orderStatus !== originalOrderStatus;
            const trafficChanged = trafficStatus && trafficStatus !== originalTrafficStatus;
            
            // Determine change type
            let changeType = null;
            if (orderChanged && trafficChanged) {
                changeType = 'both';
            } else if (orderChanged) {
                changeType = 'io';
            } else if (trafficChanged) {
                changeType = 'traffic';
            }
            
            // Build JSON only with changed sections
            const updateData = {
                change_type: changeType,
                user: currentUser.email
            };
            
            // Add order section only if changed (always include comment field)
            if (orderChanged) {
                updateData.io = {
                    status: orderStatus,
                    comment: orderComments || ''
                };
            }
            
            // Add traffic section only if changed (always include comment field)
            if (trafficChanged) {
                updateData.traffic = {
                    status: trafficStatus,
                    comment: trafficComments || ''
                };
            }
            
            console.log('=== SUBMISSION DATA ===');
            console.log(JSON.stringify(updateData, null, 2));
            console.log('======================');
            
            alert('Update submitted successfully!\n\nCheck the browser console (F12) to see the JSON payload.\n\nIn production, this will be sent to Power Automate.');
            closeUpdateForm();
        }

        // Initialize
        checkAuthentication();
    </script>
</body>
</html>
