<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #323130;
            padding: 20px;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 32px;
        }

        /* User Selector */
        .user-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .current-user:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0078d4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-dropdown-icon {
            font-size: 12px;
            color: #605e5c;
        }
        .file-item.archived {
            opacity: 0.6;
            background: #f3f2f1;
        }
        
        .archived-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #797775;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .user-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-width: 250px;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f2f1;
            transition: background 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f3f2f1;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item.active {
            background: #e6f4ff;
            font-weight: 600;
        }

        /* Auth Modal */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .auth-overlay.show {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            padding: 32px;
        }

        .auth-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-modal-subtitle {
            font-size: 14px;
            color: #605e5c;
            margin-bottom: 24px;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .auth-select:focus {
            outline: none;
            border-color: #0078d4;
        }

        .auth-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .auth-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .auth-checkbox-label {
            font-size: 14px;
            color: #323130;
            cursor: pointer;
        }

        .auth-submit-btn {
            width: 100%;
            padding: 12px 24px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-submit-btn:hover {
            background: #106ebe;
        }

        .auth-submit-btn:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        /* Header */
        .page-header {
            border-bottom: 2px solid #0078d4;
            padding-bottom: 16px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #0078d4;
        }

        .header-badges {
            display: flex;
            gap: 8px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.streaming {
            background: #8764b8;
            color: white;
        }

        .badge.billing {
            background: #00b7c3;
            color: white;
        }

        .badge.budget {
            background: #107c10;
            color: white;
        }

        /* Info Grid */
        .info-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .info-item {
            padding: 0;
            background: transparent;
            border-radius: 0;
            border-left: none;
        }

        .info-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .info-value {
            font-size: 15px;
            color: #323130;
            font-weight: 500;
        }

        /* Overall Status - Text Only */
        .overall-status {
            font-size: 16px;
            font-weight: 700;
        }

        .overall-status.confirmed {
            color: #107c10;
        }

        .overall-status.awaiting {
            color: #f7630c;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #0078d4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #0078d4;
            border-radius: 2px;
        }

        .team-role {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .team-name {
            font-size: 15px;
            font-weight: 500;
            color: #323130;
        }

        /* Comments Section */
        .comment-box {
            padding: 16px;
            background: #fff4ce;
            border-radius: 4px;
            border-left: 4px solid #f7630c;
            margin-bottom: 0;
        }

        .comment-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .comment-text {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        .comment-empty {
            font-style: italic;
            color: #a19f9d;
        }

        /* Collapsible Extended Details */
        .collapsible-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
        }

        .collapsible-header {
            padding: 0;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            margin-bottom: 0;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-title {
            font-size: 18px;
            font-weight: 600;
            color: #0078d4;
        }

        .collapsible-icon {
            font-size: 20px;
            color: #605e5c;
            transition: transform 0.3s;
        }

        .collapsible-icon.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.open {
            max-height: 500px;
        }

        .collapsible-inner {
            padding: 20px 0 0 0;
            background: transparent;
            border-radius: 0;
        }

        .detail-item {
            padding: 12px 0;
            border-bottom: 1px solid #e1e1e1;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .detail-item-value {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        /* Status Section */
        .status-section-wrapper {
            margin-bottom: 32px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .status-card {
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 2px solid #e1e1e1;
        }

        .status-label {
            font-size: 14px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .status-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .status-confirmed {
            color: #107c10;
        }

        .status-pending {
            color: #f7630c;
        }

        .status-rejected {
            color: #d13438;
        }

        .status-not-uploaded {
            color: #a19f9d;
        }

        .status-meta {
            font-size: 12px;
            color: #797775;
            margin-bottom: 12px;
        }

        .status-comment {
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #323130;
            border: 1px solid #e1e1e1;
        }

        .status-comment.confirmed-bg {
            background: rgba(16, 124, 16, 0.1);
            border-color: rgba(16, 124, 16, 0.3);
        }

        .status-comment.pending-bg {
            background: rgba(247, 99, 12, 0.1);
            border-color: rgba(247, 99, 12, 0.3);
        }

        .status-comment.rejected-bg {
            background: rgba(209, 52, 56, 0.1);
            border-color: rgba(209, 52, 56, 0.3);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
        }

        .btn-primary:hover {
            background: #106ebe;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: white;
            color: #0078d4;
            border: 2px solid #0078d4;
        }

        .btn-secondary:hover {
            background: #f3f2f1;
        }

        /* Files Section */
        .files-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #e1e1e1;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e1e1e1;
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #605e5c;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f3f2f1;
        }

        .tab.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #fafafa;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #f3f2f1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 15px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: #605e5c;
        }

        .download-btn {
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #106ebe;
        }

        .not-uploaded {
            text-align: center;
            color: #a19f9d;
            font-size: 14px;
            padding: 32px;
        }

        /* Update Modal */
        .update-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .update-modal-overlay.show {
            display: flex;
        }

        .update-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .update-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #323130;
        }

        .update-form-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .update-form-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #323130;
        }

        .update-form-group {
            margin-bottom: 16px;
        }

        .update-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .update-form-label .required {
            color: #d13438;
        }

        .update-form-select,
        .update-form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
        }

        .update-form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .update-form-select:focus,
        .update-form-textarea:focus {
            outline: none;
            border-color: #0078d4;
        }

        .update-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .update-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .update-modal-btn.cancel {
            background: #f3f2f1;
            color: #323130;
        }

        .update-modal-btn.cancel:hover {
            background: #e1e1e1;
        }

        .update-modal-btn.submit {
            background: #0078d4;
            color: white;
        }

        .update-modal-btn.submit:hover {
            background: #106ebe;
        }

        .update-modal-btn.submit:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
        /* Version Warning Modal */
.version-warning-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10002;
    align-items: center;
    justify-content: center;
}

.version-warning-overlay.show {
    display: flex;
}

.version-warning-modal {
    background: white;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 500px;
    padding: 40px;
    text-align: center;
}

.version-warning-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.version-warning-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #d13438;
}

.version-warning-text {
    font-size: 16px;
    color: #605e5c;
    line-height: 1.5;
    margin-bottom: 24px;
}

.version-warning-btn {
    padding: 12px 32px;
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.version-warning-btn:hover {
    background: #106ebe;
}
    </style>
</head>
<body>
    <!-- User Authentication Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2 class="auth-modal-title">Select Your Account</h2>
            <p class="auth-modal-subtitle">Choose your account to continue</p>
            
            <div class="auth-form-group">
                <label class="auth-form-label" for="userSelect">Your Account</label>
                <select class="auth-select" id="userSelect">
                    <option value="">-- Select Your Account --</option>
                </select>
            </div>

            <div class="auth-checkbox-group">
                <input type="checkbox" id="rememberMe" class="auth-checkbox">
                <label for="rememberMe" class="auth-checkbox-label">Remember me on this device</label>
            </div>

            <button class="auth-submit-btn" id="authSubmit" disabled>Continue</button>
        </div>
    </div>
    <!-- Version Warning Modal -->
<div class="version-warning-overlay" id="versionWarningOverlay">
    <div class="version-warning-modal">
        <div class="version-warning-icon">⚠️</div>
        <h2 class="version-warning-title">Outdated Link Version</h2>
        <p class="version-warning-text" id="versionWarningText"></p>
        <button class="version-warning-btn" onclick="closeVersionWarning()">OK</button>
    </div>
</div>

    <!-- User Selector in Top Right -->
    <div class="user-selector" id="userSelector" style="display: none;">
        <div class="current-user" onclick="toggleUserDropdown()">
            <div class="user-icon" id="userIcon"></div>
            <span class="user-name" id="currentUserName"></span>
            <span class="user-dropdown-icon">▼</span>
        </div>
        <div class="user-dropdown-menu" id="userDropdownMenu"></div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle"></h1>
            <div class="header-badges">
                <div class="badge streaming" id="streamingBadge"></div>
                <div class="badge billing" id="billingBadge"></div>
                <div class="badge budget" id="budgetBadge"></div>
            </div>
        </div>

        <!-- First Section: All Basic Info -->
        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Advertiser</div>
                    <div class="info-value" id="advertiser"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Agency</div>
                    <div class="info-value" id="agency"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Vendor</div>
                    <div class="info-value" id="vendor"></div>
                </div>
            </div>

            <div style="height: 20px;"></div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Flight Dates</div>
                    <div class="info-value" id="flightDates"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Placement</div>
                    <div class="info-value" id="placement"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Overall Status</div>
                    <div class="overall-status" id="overallStatus"></div>
                </div>
            </div>

            <div style="height: 32px;"></div>

            <!-- Team Members -->
            <div class="info-grid">
                <div class="info-item">
                    <div class="team-role">Account Executive</div>
                    <div class="team-name" id="aeName"></div>
                </div>
                <div class="info-item">
                    <div class="team-role">Campaign Manager</div>
                    <div class="team-name" id="cmName"></div>
                </div>
                <div class="info-item">
                    <div class="team-role">Operations Lead</div>
                    <div class="team-name" id="olName"></div>
                </div>
            </div>

            <div style="height: 32px;"></div>

            <!-- AMP Comment -->
            <div class="comment-box">
                <div class="comment-label">Ampersand Comment</div>
                <div class="comment-text" id="ampComment"></div>
            </div>
        </div>

        <!-- Collapsible Extended Order Details -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleExtendedDetails()">
                <span class="collapsible-title">Geo and Audience Targets</span>
                <span class="collapsible-icon" id="extendedIcon">▼</span>
            </div>
            <div class="collapsible-content" id="extendedContent">
                <div class="collapsible-inner">
                    <div class="detail-item">
                        <div class="detail-item-label">Geo Target</div>
                        <div class="detail-item-value" id="geoTarget"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-item-label">Pre-built Audience Target</div>
                        <div class="detail-item-value" id="demoTarget"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-item-label">List Match Audience Target</div>
                        <div class="detail-item-value" id="listMatch"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="status-section-wrapper">
            <h2 class="section-title">Status Details</h2>
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label">Order Status</div>
                    <div class="status-value" id="orderStatus"></div>
                    <div class="status-meta" id="orderStatusMeta"></div>
                    <div class="status-comment" id="orderStatusComment"></div>
                </div>
                <div class="status-card">
                    <div class="status-label">Traffic Status</div>
                    <div class="status-value" id="trafficStatus"></div>
                    <div class="status-meta" id="trafficStatusMeta"></div>
                    <div class="status-comment" id="trafficStatusComment"></div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openUpdateForm()">Change Status</button>
                <button class="btn btn-secondary" onclick="emailTeam()">Email the Team</button>
            </div>
        </div>

        <!-- Files Section -->
       <div class="files-section">
    <h2 class="section-title">Files</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div class="tabs">
            <button class="tab active" data-type="IO" onclick="switchTab('IO')">IO</button>
            <button class="tab" data-type="Traffic" onclick="switchTab('Traffic')">Traffic & Creative</button>
            <button class="tab" data-type="Other" onclick="switchTab('Other')">Other</button>
        </div>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="showArchived" onchange="renderFiles()" style="cursor: pointer;">
            <span style="font-size: 14px; font-weight: 600; color: #605e5c;">Show Archived</span>
        </label>
    </div>
    <div class="file-list" id="fileList"></div>
</div>

   
    </div>
 <!-- Update Status Modal -->
    <div class="update-modal-overlay" id="updateModalOverlay">
        <div class="update-modal">
            <h2 class="update-modal-title">Update Order Status</h2>
            
            <div class="update-form-section">
                <h3>Order Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">Status</label>
                    <select class="update-form-select" id="updateOrderStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="orderCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateOrderComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-form-section">
                <h3>Traffic Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">Status</label>
                    <select class="update-form-select" id="updateTrafficStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="trafficCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateTrafficComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-modal-actions">
                <button class="update-modal-btn cancel" onclick="closeUpdateForm()">Cancel</button>
                <button class="update-modal-btn submit" id="submitUpdateBtn" onclick="submitUpdate()">Change Status</button>
            </div>
        </div>
    <script>
        // User data
        const usersData = [
            { name: "Jeff", email: "jeff@ribeye.media", initials: "JG" },
            { name: "Matt", email: "matt@ribeye.media", initials: "MD" },
            { name: "Kareem", email: "kareem@ribeye.media", initials: "K" },
            { name: "Arwa", email: "arwa@ribeye.media", initials: "A" },
            { name: "Nouman", email: "nouman@ribeye.media", initials: "N" },
            { name: "Test", email: "Test", initials: "T" }
        ];

        let orderData = null;
        let filesData = null;
        let currentTab = 'IO';
        let currentUser = null;
        let orderId = null;
        let originalOrderStatus = null;
        let originalTrafficStatus = null;
        let originalOrderComment = null;
        let originalTrafficComment = null;

        const API_BASE_URL = 'https://default4657d5eea660475fbb1099b5df3efd.46.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c64389bbba15477eb0b909200beb65b1/triggers/manual/paths/invoke';

        // Fetch order data from Power Automate
        async function fetchOrderData(id) {
            try {
                const url = API_BASE_URL + '?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OymdpruJbg2QyqJstyrh8qKTXDltEiQax89t2odSIvc&id=' + id;
                
                console.log('Fetching from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    showErrorModal();
                    return false;
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (!data.order || !data.files) {
                    console.error('Invalid response structure:', data);
                    showErrorModal();
                    return false;
                }

                orderData = data.order;
                filesData = data.files;
                return true;

            } catch (error) {
                console.error('Error fetching order data:', error);
                showErrorModal();
                return false;
            }
        }
// Extract version from URL
function extractVersionFromPath() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('version');
}

// Check version mismatch
function checkVersionMismatch(urlVersion, dataVersion) {
    const warningText = document.getElementById('versionWarningText');
    
    if (!urlVersion) {
        warningText.textContent = 'No version number was included in the link. Please reference files on this page for the most up-to-date information.';
        document.getElementById('versionWarningOverlay').classList.add('show');
        return;
    }
    
    if (urlVersion !== dataVersion) {
        warningText.textContent = 'You\'re using a link from an older version. To ensure you\'re viewing the correct files, please reference the latest email or download the latest files from this page.';
        document.getElementById('versionWarningOverlay').classList.add('show');
    }
}

// Close version warning
function closeVersionWarning() {
    document.getElementById('versionWarningOverlay').classList.remove('show');
}
        // Show error modal
        function showErrorModal() {
            const errorHtml = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;">' +
                '<div style="background: white; padding: 40px; border-radius: 8px; max-width: 500px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">' +
                    '<div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>' +
                    '<h2 style="color: #d13438; margin-bottom: 16px; font-size: 24px;">Unable to Load Order</h2>' +
                    '<p style="color: #605e5c; margin-bottom: 24px; font-size: 16px; line-height: 1.5;">We couldn\'t retrieve the order information. This could be due to an invalid order ID or a connection issue.</p>' +
                    '<p style="color: #323130; font-weight: 600; margin-bottom: 24px; font-size: 14px;">Please reach out to the team via email for assistance.</p>' +
                    '<a href="mailto:support@ampersand.tv?subject=Order Access Issue&body=I am unable to access order details. Please assist." style="display: inline-block; padding: 12px 32px; background: #0078d4; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 16px;">Email Support Team</a>' +
                '</div>' +
            '</div>';

            document.body.insertAdjacentHTML('beforeend', errorHtml);
        }

        // Extract order ID from URL
        function extractOrderIdFromPath() {
            const urlParams = new URLSearchParams(window.location.search);
            const queryId = urlParams.get('id');
            if (queryId) {
                return queryId;
            }
            
            const path = window.location.pathname;
            const cleanPath = path.replace('/ampdigital/', '').replace('/ampdigital', '').replace('.html', '');
            const parts = cleanPath.split('/').filter(function(p) { return p && p.trim() !== ''; });
            
            for (let i = parts.length - 1; i >= 0; i--) {
                const part = parts[i];
                if (!isNaN(part) && part !== '') {
                    return part;
                }
            }
            
            return null;
        }

        // Check authentication
        function checkAuthentication() {
            orderId = extractOrderIdFromPath();
            
            if (!orderId) {
                showErrorModal();
                return;
            }
            
            const savedUser = localStorage.getItem('selectedUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainContent();
                } catch (e) {
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
        }

        // Show auth modal
        function showAuthModal() {
            const authOverlay = document.getElementById('authOverlay');
            const userSelect = document.getElementById('userSelect');
            
            usersData.forEach(function(user) {
                const option = document.createElement('option');
                option.value = JSON.stringify(user);
                option.textContent = user.name + ' (' + user.email + ')';
                userSelect.appendChild(option);
            });
            
            authOverlay.classList.add('show');
        }

        // Auth submit handler
        document.getElementById('userSelect').addEventListener('change', function() {
            const submitBtn = document.getElementById('authSubmit');
            submitBtn.disabled = !this.value;
        });

        document.getElementById('authSubmit').addEventListener('click', function() {
            const userSelect = document.getElementById('userSelect');
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (userSelect.value) {
                currentUser = JSON.parse(userSelect.value);
                
                if (rememberMe) {
                    localStorage.setItem('selectedUser', JSON.stringify(currentUser));
                }
                
                document.getElementById('authOverlay').classList.remove('show');
                showMainContent();
            }
        });

        // Show main content
        async function showMainContent() {
            document.getElementById('userIcon').textContent = currentUser.initials;
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('userSelector').style.display = 'block';
            
            populateUserDropdown();
            
            const mainContent = document.getElementById('mainContent');
            mainContent.style.display = 'block';
            mainContent.innerHTML = '<div style="text-align: center; padding: 100px 20px;">' +
                '<div style="font-size: 48px; margin-bottom: 20px;">⏳</div>' +
                '<div style="font-size: 20px; color: #605e5c;">Loading order details...</div>' +
            '</div>';
            
            const success = await fetchOrderData(orderId);
            
            if (success) {
                    // Check version mismatch
    const urlVersion = extractVersionFromPath();
    const dataVersion = orderData.version || orderData.Version;
    checkVersionMismatch(urlVersion, dataVersion)

                
                // Restore the full page structure
                mainContent.innerHTML = `
                    <!-- Header -->
                    <div class="page-header">
                        <h1 class="page-title" id="pageTitle"></h1>
                        <div class="header-badges">
                            <div class="badge streaming" id="streamingBadge"></div>
                            <div class="badge billing" id="billingBadge"></div>
                            <div class="badge budget" id="budgetBadge"></div>
                        </div>
                    </div>

                    <!-- First Section: All Basic Info -->
                    <div class="info-section">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Advertiser</div>
                                <div class="info-value" id="advertiser"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Agency</div>
                                <div class="info-value" id="agency"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Vendor</div>
                                <div class="info-value" id="vendor"></div>
                            </div>
                        </div>

                        <div style="height: 20px;"></div>

                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Flight Dates</div>
                                <div class="info-value" id="flightDates"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Placement</div>
                                <div class="info-value" id="placement"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Overall Status</div>
                                <div class="overall-status" id="overallStatus"></div>
                            </div>
                        </div>

                        <div style="height: 32px;"></div>

                        <!-- Team Members -->
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="team-role">Account Executive</div>
                                <div class="team-name" id="aeName"></div>
                            </div>
                            <div class="info-item">
                                <div class="team-role">Campaign Manager</div>
                                <div class="team-name" id="cmName"></div>
                            </div>
                            <div class="info-item">
                                <div class="team-role">Operations Lead</div>
                                <div class="team-name" id="olName"></div>
                            </div>
                        </div>

                        <div style="height: 32px;"></div>

                        <!-- AMP Comment -->
                        <div class="comment-box">
                            <div class="comment-label">Ampersand Comment</div>
                            <div class="comment-text" id="ampComment"></div>
                        </div>
                    </div>

                    <!-- Collapsible Extended Order Details -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleExtendedDetails()">
                            <span class="collapsible-title">Geo and Audience Targets</span>
                            <span class="collapsible-icon" id="extendedIcon">▼</span>
                        </div>
                        <div class="collapsible-content" id="extendedContent">
                            <div class="collapsible-inner">
                                <div class="detail-item">
                                    <div class="detail-item-label">Geo Target</div>
                                    <div class="detail-item-value" id="geoTarget"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">Pre-built Audience Target</div>
                                    <div class="detail-item-value" id="demoTarget"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-item-label">List Match Audience Target</div>
                                    <div class="detail-item-value" id="listMatch"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="status-section-wrapper">
                        <h2 class="section-title">Status Details</h2>
                        <div class="status-grid">
                            <div class="status-card">
                                <div class="status-label">Order Status</div>
                                <div class="status-value" id="orderStatus"></div>
                                <div class="status-meta" id="orderStatusMeta"></div>
                                <div class="status-comment" id="orderStatusComment"></div>
                            </div>
                            <div class="status-card">
                                <div class="status-label">Traffic Status</div>
                                <div class="status-value" id="trafficStatus"></div>
                                <div class="status-meta" id="trafficStatusMeta"></div>
                                <div class="status-comment" id="trafficStatusComment"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="openUpdateForm()">Change Status</button>
                            <button class="btn btn-secondary" onclick="emailTeam()">Email the Team</button>
                        </div>
                    </div>

                   <!-- Files Section -->
                    <div class="files-section">
                        <h2 class="section-title">Files</h2>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="tabs">
                                <button class="tab active" data-type="IO" onclick="switchTab('IO')">IO</button>
                                <button class="tab" data-type="Traffic" onclick="switchTab('Traffic')">Traffic</button>
                                <button class="tab" data-type="Other" onclick="switchTab('Other')">Other</button>
                            </div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="showArchived" onchange="renderFiles()" style="cursor: pointer;">
                                <span style="font-size: 14px; font-weight: 600; color: #605e5c;">Show Archived</span>
                            </label>
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>
                `;
                
                // Now populate with data
                initializePage();
            }
        }

        // Populate user dropdown
        function populateUserDropdown() {
            const dropdownMenu = document.getElementById('userDropdownMenu');
            dropdownMenu.innerHTML = '';
            
            usersData.forEach(function(user) {
                const item = document.createElement('div');
                item.className = 'user-dropdown-item';
                if (user.email === currentUser.email) {
                    item.classList.add('active');
                }
                item.innerHTML = '<div style="font-weight: 600;">' + user.name + '</div>' +
                    '<div style="font-size: 12px; color: #605e5c;">' + user.email + '</div>';
                item.onclick = function() {
                    switchUser(user);
                };
                dropdownMenu.appendChild(item);
            });
        }

        // Toggle dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown on outside click
        document.addEventListener('click', function(event) {
            const userSelector = document.getElementById('userSelector');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (!userSelector.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Switch user
        function switchUser(user) {
            currentUser = user;
            localStorage.setItem('selectedUser', JSON.stringify(currentUser));
            
            document.getElementById('userIcon').textContent = user.initials;
            document.getElementById('currentUserName').textContent = user.name;
            
            populateUserDropdown();
            document.getElementById('userDropdownMenu').classList.remove('show');
            
            console.log('User switched to:', user.email);
        }

        // Toggle extended details
        function toggleExtendedDetails() {
            const content = document.getElementById('extendedContent');
            const icon = document.getElementById('extendedIcon');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                content.classList.add('open');
                icon.classList.add('open');
            }
        }

        // Initialize page
        function initializePage() {
            populateOrderDetails();
            renderFiles();
        }

        function populateOrderDetails() {
            if (!orderData) {
                console.error('No order data available');
                return;
            }

            // Page Title with POL prefix
            const orderType = orderData["Order Type"] || orderData.OrderType || '';
            const prefix = orderType === "Political" ? "POL " : "";
            const advertiser = orderData.Advertiser || orderData.Title || 'Order';
            const opid = orderData.OPID || '';
            
            if (prefix) {
                document.getElementById('pageTitle').innerHTML = '<span style="font-weight: 900;">' + prefix + '</span>' + advertiser + ' - ' + opid;
            } else {
                document.getElementById('pageTitle').textContent = advertiser + ' - ' + opid;
            }

            // Header badges
            const streaming = orderData.StreamingvsAddressable 
                ? (typeof orderData.StreamingvsAddressable === 'object' ? orderData.StreamingvsAddressable.Value : orderData.StreamingvsAddressable)
                : 'N/A';
            const billing = orderData.Billingparty 
                ? (typeof orderData.Billingparty === 'object' ? orderData.Billingparty.Value : orderData.Billingparty)
                : 'N/A';
            
            document.getElementById('streamingBadge').textContent = streaming;
            document.getElementById('billingBadge').textContent = billing;
            document.getElementById('budgetBadge').textContent = orderType || orderData.Budget || 'N/A';

            // First row
            document.getElementById('advertiser').textContent = advertiser;
            document.getElementById('agency').textContent = orderData.Agency || 'N/A';
            
            const vendor = orderData.Vendor || (orderData.MVPDContacts 
                ? (typeof orderData.MVPDContacts === 'object' ? orderData.MVPDContacts.Value : orderData.MVPDContacts)
                : 'N/A');
            document.getElementById('vendor').textContent = vendor;

            // Second row
            const flightStart = formatDateShort(orderData.FlightStar || orderData.FlightStart);
            const flightEnd = formatDateShort(orderData.FlightEnd);
            document.getElementById('flightDates').textContent = flightStart + ' - ' + flightEnd;
            document.getElementById('placement').textContent = orderData.Placement || 'N/A';
            
            // Overall Status
            const orderStatus = orderData.Status 
                ? (typeof orderData.Status === 'object' ? orderData.Status.Value : orderData.Status)
                : '';
            const trafficStatus = orderData.TrafficStatus 
                ? (typeof orderData.TrafficStatus === 'object' ? orderData.TrafficStatus.Value : orderData.TrafficStatus)
                : '';
            
            const overallStatus = (orderStatus === 'Confirmed' && trafficStatus === 'Confirmed') ? 'Confirmed' : 'Awaiting Review';
            const overallStatusEl = document.getElementById('overallStatus');
            overallStatusEl.textContent = overallStatus;
            overallStatusEl.className = 'overall-status ' + (overallStatus === 'Confirmed' ? 'confirmed' : 'awaiting');

            // Team
            const aeName = orderData.AE 
                ? (orderData.AE.DisplayName || 'N/A')
                : 'N/A';
            const cmName = orderData.CM 
                ? (orderData.CM.DisplayName || (orderData.CampaignManager ? orderData.CampaignManager.DisplayName : 'N/A'))
                : (orderData.CampaignManager ? orderData.CampaignManager.DisplayName : 'N/A');
            const olName = orderData.OL 
                ? (orderData.OL.DisplayName || (orderData.OpsLead ? orderData.OpsLead.DisplayName : 'N/A'))
                : (orderData.OpsLead ? orderData.OpsLead.DisplayName : 'N/A');
            
            document.getElementById('aeName').textContent = aeName;
            document.getElementById('cmName').textContent = cmName;
            document.getElementById('olName').textContent = olName;

            // AMP Comment
            const ampCommentEl = document.getElementById('ampComment');
            if (orderData.AMPComment) {
                ampCommentEl.textContent = orderData.AMPComment;
            } else {
                ampCommentEl.innerHTML = '<span class="comment-empty">No comment</span>';
            }

            // Extended Details
            document.getElementById('geoTarget').textContent = orderData.GeoTarget || 'N/A';
            document.getElementById('demoTarget').textContent = orderData.DemoTarget || 'N/A';
            document.getElementById('listMatch').textContent = orderData.ListMatch || orderData.ListMatchDemo || 'N/A';

            // Order Status
            const orderStatusEl = document.getElementById('orderStatus');
            orderStatusEl.textContent = orderStatus || 'Unknown';
            orderStatusEl.className = 'status-value ' + getStatusClass(orderStatus);
            
            const orderStatusMeta = document.getElementById('orderStatusMeta');
            if (orderData.Statuschange) {
                let timeText = formatDateTime(orderData.Statuschange);
                if (orderData.StatusUpdatedby) {
                    timeText += ' by ' + orderData.StatusUpdatedby;
                }
                orderStatusMeta.textContent = timeText;
            } else {
                orderStatusMeta.textContent = 'Never updated';
            }

            const orderStatusComment = document.getElementById('orderStatusComment');
            orderStatusComment.className = 'status-comment ' + getStatusBackgroundClass(orderStatus);
            if (orderData.IOAffComment) {
                orderStatusComment.textContent = '"' + orderData.IOAffComment + '"';
            } else {
                orderStatusComment.innerHTML = '<span class="comment-empty">No affiliate comments</span>';
            }

            // Traffic Status
            const trafficStatusEl = document.getElementById('trafficStatus');
            trafficStatusEl.textContent = trafficStatus || 'Unknown';
            trafficStatusEl.className = 'status-value ' + getStatusClass(trafficStatus);
            
            const trafficStatusMeta = document.getElementById('trafficStatusMeta');
            if (orderData.TrafficStatusChange) {
                let timeText = formatDateTime(orderData.TrafficStatusChange);
                if (orderData.TrafficStatusUpdatedby) {
                    timeText += ' by ' + orderData.TrafficStatusUpdatedby;
                }
                trafficStatusMeta.textContent = timeText;
            } else {
                trafficStatusMeta.textContent = 'Never updated';
            }

            const trafficStatusComment = document.getElementById('trafficStatusComment');
            trafficStatusComment.className = 'status-comment ' + getStatusBackgroundClass(trafficStatus);
            if (orderData.TrafficAffComment) {
                trafficStatusComment.textContent = '"' + orderData.TrafficAffComment + '"';
            } else {
                trafficStatusComment.innerHTML = '<span class="comment-empty">No affiliate comments</span>';
            }
        }

        function getStatusClass(status) {
            if (status === 'Confirmed') return 'status-confirmed';
            if (status === 'Pending') return 'status-pending';
            if (status === 'Rejected') return 'status-rejected';
            if (status === 'Not Uploaded') return 'status-not-uploaded';
            return '';
        }

        function getStatusBackgroundClass(status) {
            if (status === 'Confirmed') return 'confirmed-bg';
            if (status === 'Pending') return 'pending-bg';
            if (status === 'Rejected') return 'rejected-bg';
            return '';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        function formatDateShort(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return (date.getMonth() + 1) + '/' + date.getDate();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelector('[data-type="' + tabName + '"]').classList.add('active');
            
            renderFiles();
        }

        function renderFiles() {
    const fileList = document.getElementById('fileList');
    const showArchived = document.getElementById('showArchived').checked;
    
    if (!filesData || filesData.length === 0) {
        fileList.innerHTML = '<div class="not-uploaded">No files available</div>';
        return;
    }
    
    // Filter by tab and archive status
    let filteredFiles = filesData.filter(function(file) {
        const fileType = file.file_type;
        const isArchived = file.Archived === true || file.Archived === 'true';
        
        // Must match current tab
        if (fileType !== currentTab) return false;
        
        // If not showing archived, exclude archived files
        if (!showArchived && isArchived) return false;
        
        return true;
    });

    // Sort by creation date (newest first)
    filteredFiles.sort(function(a, b) {
        return new Date(b.Created) - new Date(a.Created);
    });

    if (filteredFiles.length === 0) {
        fileList.innerHTML = '<div class="not-uploaded">No files available for this category</div>';
        return;
    }

    fileList.innerHTML = filteredFiles.map(function(file) {
        const fileName = file.Name || 'Unnamed File';
        const fileDate = formatDate(file.Created);
        const fullPath = file.FullPath || '';
        const isArchived = file.Archived === true || file.Archived === 'true';
        
        const downloadUrl = fullPath 
            ? 'https://datadriventv.sharepoint.com/sites/PoliticalStreaming/_layouts/15/download.aspx?SourceUrl=/sites/PoliticalStreaming/' + encodeURIComponent(fullPath)
            : '#';

        let archivedBadge = '';
        let archivedClass = '';
        if (isArchived) {
            archivedClass = ' archived';
            const archivedDate = file.Archived_date ? formatDate(file.Archived_date) : '';
            archivedBadge = '<span class="archived-badge">Archived' + (archivedDate ? ' ' + archivedDate : '') + '</span>';
        }

        return '<div class="file-item' + archivedClass + '">' +
            '<div class="file-info">' +
                '<div class="file-name">' + fileName + archivedBadge + '</div>' +
                '<div class="file-meta">' + fileDate + '</div>' +
            '</div>' +
            '<a href="' + downloadUrl + '" target="_blank" class="download-btn">↓ Download</a>' +
        '</div>';
    }).join('');
}

        // Email team
        function emailTeam() {
            // Get emails from team members (handle both formats)
            const aeEmail = orderData.AE && orderData.AE.Email 
                ? orderData.AE.Email 
                : '';
            const cmEmail = orderData.CM && orderData.CM.Email 
                ? orderData.CM.Email 
                : (orderData.CampaignManager && orderData.CampaignManager.Email ? orderData.CampaignManager.Email : '');
            const olEmail = orderData.OL && orderData.OL.Email 
                ? orderData.OL.Email 
                : (orderData.OpsLead && orderData.OpsLead.Email ? orderData.OpsLead.Email : '');
            
            const toEmails = [aeEmail, cmEmail, olEmail].filter(function(e) { return e; }).join(',');
            
            const ccEmails = [aeEmail, cmEmail, olEmail, 'kostiantyn.rymar@ampersand.tv']
                .filter(function(e) { return e; })
                .filter(function(email, index, self) {
                    return self.indexOf(email) === index;
                })
                .join(',');
            
            const orderType = orderData["Order Type"] || orderData.OrderType || '';
            const prefix = orderType === "Political" ? "POL " : "";
            const advertiser = orderData.Advertiser || orderData.Title || 'Order';
            const flightStart = formatDateShort(orderData.FlightStar || orderData.FlightStart);
            const flightEnd = formatDateShort(orderData.FlightEnd);
            const opid = orderData.OPID || '';
            
            const subject = prefix + advertiser + ' (' + flightStart + ' - ' + flightEnd + ') - ' + opid;
            const body = 'Hi Team,%0D%0A%0D%0AI have a question regarding this order.%0D%0A%0D%0AThank you!';
            
            const mailtoLink = 'mailto:' + toEmails + '?cc=' + ccEmails + '&subject=' + encodeURIComponent(subject) + '&body=' + body;
            
            window.location.href = mailtoLink;
        }

        // Update form
        function openUpdateForm() {
            document.getElementById('updateModalOverlay').classList.add('show');
            
            // Extract status values (handle both old object format and new string format)
            const currentOrderStatus = orderData.Status 
                ? (typeof orderData.Status === 'object' ? orderData.Status.Value : orderData.Status)
                : '';
            const currentTrafficStatus = orderData.TrafficStatus 
                ? (typeof orderData.TrafficStatus === 'object' ? orderData.TrafficStatus.Value : orderData.TrafficStatus)
                : '';
            
            originalOrderStatus = currentOrderStatus;
            originalTrafficStatus = currentTrafficStatus;
            originalOrderComment = orderData.IOAffComment || '';
            originalTrafficComment = orderData.TrafficAffComment || '';
            
            const orderStatusSelect = document.getElementById('updateOrderStatus');
            const trafficStatusSelect = document.getElementById('updateTrafficStatus');
            
            if (originalOrderStatus === 'Confirmed' || originalOrderStatus === 'Rejected') {
                orderStatusSelect.value = originalOrderStatus;
                const emptyOption = orderStatusSelect.querySelector('option[value=""]');
                if (emptyOption) emptyOption.remove();
            } else {
                orderStatusSelect.value = originalOrderStatus;
            }
            
            if (originalTrafficStatus === 'Confirmed' || originalTrafficStatus === 'Rejected') {
                trafficStatusSelect.value = originalTrafficStatus;
                const emptyOption = trafficStatusSelect.querySelector('option[value=""]');
                if (emptyOption) emptyOption.remove();
            } else {
                trafficStatusSelect.value = originalTrafficStatus;
            }
            
            document.getElementById('updateOrderComments').value = originalOrderComment;
            document.getElementById('updateTrafficComments').value = originalTrafficComment;
            
            const orderSection = document.querySelector('.update-form-section:nth-of-type(1)');
            const trafficSection = document.querySelector('.update-form-section:nth-of-type(2)');
            
            if (orderSection) {
                if (originalOrderStatus === 'Not Uploaded') {
                    orderSection.style.opacity = '0.5';
                    orderSection.style.pointerEvents = 'none';
                    document.getElementById('updateOrderStatus').disabled = true;
                    document.getElementById('updateOrderComments').disabled = true;
                } else {
                    orderSection.style.opacity = '1';
                    orderSection.style.pointerEvents = 'auto';
                    document.getElementById('updateOrderStatus').disabled = false;
                    document.getElementById('updateOrderComments').disabled = false;
                }
            }
            
            if (trafficSection) {
                if (originalTrafficStatus === 'Not Uploaded') {
                    trafficSection.style.opacity = '0.5';
                    trafficSection.style.pointerEvents = 'none';
                    document.getElementById('updateTrafficStatus').disabled = true;
                    document.getElementById('updateTrafficComments').disabled = true;
                } else {
                    trafficSection.style.opacity = '1';
                    trafficSection.style.pointerEvents = 'auto';
                    document.getElementById('updateTrafficStatus').disabled = false;
                    document.getElementById('updateTrafficComments').disabled = false;
                }
            }
            
            updateFormValidation();
        }

        function closeUpdateForm() {
            document.getElementById('updateModalOverlay').classList.remove('show');
            document.getElementById('updateOrderStatus').value = '';
            document.getElementById('updateOrderComments').value = '';
            document.getElementById('updateTrafficStatus').value = '';
            document.getElementById('updateTrafficComments').value = '';
            
            const orderStatusSelect = document.getElementById('updateOrderStatus');
            const trafficStatusSelect = document.getElementById('updateTrafficStatus');
            
            if (!orderStatusSelect.querySelector('option[value=""]')) {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select Status --';
                orderStatusSelect.insertBefore(emptyOption, orderStatusSelect.firstChild);
            }
            
            if (!trafficStatusSelect.querySelector('option[value=""]')) {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select Status --';
                trafficStatusSelect.insertBefore(emptyOption, trafficStatusSelect.firstChild);
            }
        }

        document.getElementById('updateOrderStatus').addEventListener('change', function() {
            if (this.value !== originalOrderStatus) {
                document.getElementById('updateOrderComments').value = '';
            } else {
                document.getElementById('updateOrderComments').value = originalOrderComment;
            }
            updateFormValidation();
        });

        document.getElementById('updateTrafficStatus').addEventListener('change', function() {
            if (this.value !== originalTrafficStatus) {
                document.getElementById('updateTrafficComments').value = '';
            } else {
                document.getElementById('updateTrafficComments').value = originalTrafficComment;
            }
            updateFormValidation();
        });

        document.getElementById('updateOrderComments').addEventListener('input', updateFormValidation);
        document.getElementById('updateTrafficComments').addEventListener('input', updateFormValidation);

        function updateFormValidation() {
            const orderStatus = document.getElementById('updateOrderStatus').value;
            const trafficStatus = document.getElementById('updateTrafficStatus').value;
            const orderComments = document.getElementById('updateOrderComments').value.trim();
            const trafficComments = document.getElementById('updateTrafficComments').value.trim();
            
            const orderDisabled = document.getElementById('updateOrderStatus').disabled;
            const trafficDisabled = document.getElementById('updateTrafficStatus').disabled;
            
            const orderCommentLabel = document.getElementById('orderCommentLabel');
            const trafficCommentLabel = document.getElementById('trafficCommentLabel');
            
            if (orderStatus === 'Rejected') {
                orderCommentLabel.innerHTML = 'Comments <span class="required">* (required for rejection)</span>';
            } else {
                orderCommentLabel.innerHTML = 'Comments <span style="color: #605e5c;">(optional)</span>';
            }
            
            if (trafficStatus === 'Rejected') {
                trafficCommentLabel.innerHTML = 'Comments <span class="required">* (required for rejection)</span>';
            } else {
                trafficCommentLabel.innerHTML = 'Comments <span style="color: #605e5c;">(optional)</span>';
            }
            
            let isValid = true;
            
            if (!orderDisabled && orderStatus === 'Rejected' && !orderComments) {
                isValid = false;
            }
            
            if (!trafficDisabled && trafficStatus === 'Rejected' && !trafficComments) {
                isValid = false;
            }
            
            const hasOrderChange = !orderDisabled && orderStatus && orderStatus !== originalOrderStatus;
            const hasTrafficChange = !trafficDisabled && trafficStatus && trafficStatus !== originalTrafficStatus;
            
            if (!hasOrderChange && !hasTrafficChange) {
                isValid = false;
            }
            
            if (orderDisabled && trafficDisabled) {
                isValid = false;
            }
            
            document.getElementById('submitUpdateBtn').disabled = !isValid;
        }

        function submitUpdate() {
            const orderStatus = document.getElementById('updateOrderStatus').value;
            const trafficStatus = document.getElementById('updateTrafficStatus').value;
            const orderComments = document.getElementById('updateOrderComments').value.trim();
            const trafficComments = document.getElementById('updateTrafficComments').value.trim();
            
            const orderChanged = orderStatus && orderStatus !== originalOrderStatus;
            const trafficChanged = trafficStatus && trafficStatus !== originalTrafficStatus;
            
            let changeType = null;
            if (orderChanged && trafficChanged) {
                changeType = 'both';
            } else if (orderChanged) {
                changeType = 'io';
            } else if (trafficChanged) {
                changeType = 'traffic';
            }
            
            const updateData = {
                id: orderId,
                change_type: changeType,
                user: currentUser.email
            };
            
            if (orderChanged) {
                updateData.io = {
                    status: orderStatus,
                    comment: orderComments || ''
                };
            }
            
            if (trafficChanged) {
                updateData.traffic = {
                    status: trafficStatus,
                    comment: trafficComments || ''
                };
            }
            
            console.log('=== SUBMISSION DATA ===');
            console.log(JSON.stringify(updateData, null, 2));
            console.log('======================');
            
            const updateApiUrl = 'https://default4657d5eea660475fbb1099b5df3efd.46.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ddb6aeaa697448b5a3f466170aebad6f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4HQQMYaekXI0s6exdOb-Ud7vmCNX19Y2K9h8sXjHru4';
            
            const submitBtn = document.getElementById('submitUpdateBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            fetch(updateApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Submission failed: ' + response.status);
                }
                
                return response.text().then(function(text) {
                    console.log('Raw response text:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('Response was:', text);
                        throw new Error('Invalid JSON response from server');
                    }
                });
            })
            .then(function(data) {
                console.log('Success response:', data);
                
                if (data.order) {
                    orderData = data.order;
                    populateOrderDetails();
                    console.log('Order data updated from server');
                }
                
                alert('Update submitted successfully!\n\nYour changes have been recorded.');
                closeUpdateForm();
            })
            .catch(function(error) {
                console.error('Submission error:', error);
                alert('Failed to change status.\n\nPlease try again or contact support if the issue persists.');
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Change Status';
            });
        }

        // Initialize
        checkAuthentication();
    </script>
</body>
</html>
